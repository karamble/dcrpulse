services:
  dcrd:
    image: ghcr.io/karamble/dcrpulse-dcrd:${DCRD_IMAGE_TAG:-latest}
    build:
      context: ./dcrd
      args:
        DCRD_VERSION: ${DCRD_VERSION:-release-v2.1.0}
    container_name: dcrpulse-dcrd
    ports:
      - "9108:9108"
      - "9109:9109"
    volumes:
      - ${APP_DATA_DIR:-app-data}:/app-data
    environment:
      - DCRD_EXTRA_ARGS=${DCRD_EXTRA_ARGS:---txindex}
    command: >
      --rpcuser=${DCRD_RPC_USER:-decred}
      --rpcpass=${DCRD_RPC_PASS:-decredpass}
      --rpclisten=0.0.0.0:9109
      --rpccert=/app-data/dcrd/rpc.cert
      --rpckey=/app-data/dcrd/rpc.key
    restart: unless-stopped
    networks:
      - decred-network
    healthcheck:
      test: ["CMD", "sh", "-c", "curl -k -u ${DCRD_RPC_USER:-decred}:${DCRD_RPC_PASS:-decredpass} -H 'Content-Type: application/json' -d '{\"jsonrpc\":\"1.0\",\"method\":\"getinfo\",\"params\":[],\"id\":1}' https://127.0.0.1:9109 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 120s
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2'
        reservations:
          memory: 2G

  dcrwallet:
    image: ghcr.io/karamble/dcrpulse-dcrwallet:${DCRWALLET_IMAGE_TAG:-latest}
    build:
      context: ./dcrwallet
      args:
        DCRWALLET_VERSION: ${DCRWALLET_VERSION:-release-v2.1.0}
    container_name: dcrpulse-dcrwallet
    ports:
      - "9110:9110"
      - "9111:9111"
    volumes:
      - ${APP_DATA_DIR:-app-data}:/app-data
    environment:
      - DCRWALLET_RPC_USER=${DCRWALLET_RPC_USER:-dcrwallet}
      - DCRWALLET_RPC_PASS=${DCRWALLET_RPC_PASS:-dcrwalletpass}
      - DCRD_RPC_USER=${DCRD_RPC_USER:-decred}
      - DCRD_RPC_PASS=${DCRD_RPC_PASS:-decredpass}
      - DCRD_RPC_HOST=dcrd
      - DCRWALLET_GAP_LIMIT=${DCRWALLET_GAP_LIMIT:-400}
    command: >
      --gaplimit=${DCRWALLET_GAP_LIMIT:-400}
    depends_on:
      dcrd:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - decred-network
    healthcheck:
      test: ["CMD", "sh", "-c", "nc -z 127.0.0.1 9110 && nc -z 127.0.0.1 9111 || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '1'
        reservations:
          memory: 1G

  dashboard:
    image: ghcr.io/karamble/dcrpulse-dashboard:${DASHBOARD_IMAGE_TAG:-latest}
    build: ./dashboard
    container_name: dcrpulse-dashboard
    ports:
      - "8080:8080"
    volumes:
      - ${APP_DATA_DIR:-app-data}:/app-data:ro
    environment:
      - PORT=8080
      - DCRD_RPC_HOST=dcrd
      - DCRD_RPC_PORT=9109
      - DCRD_RPC_USER=${DCRD_RPC_USER:-decred}
      - DCRD_RPC_PASS=${DCRD_RPC_PASS:-decredpass}
      - DCRD_RPC_CERT=/app-data/dcrd/rpc.cert
      - DCRWALLET_RPC_HOST=dcrwallet
      - DCRWALLET_RPC_PORT=9110
      - DCRWALLET_GRPC_PORT=9111
      - DCRWALLET_RPC_USER=${DCRWALLET_RPC_USER:-dcrwallet}
      - DCRWALLET_RPC_PASS=${DCRWALLET_RPC_PASS:-dcrwalletpass}
      - DCRWALLET_RPC_CERT=/app-data/dcrd/rpc.cert
    depends_on:
      dcrd:
        condition: service_healthy
      dcrwallet:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - decred-network
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M

networks:
  decred-network:
    driver: bridge

volumes:
  app-data:
    name: ${APP_DATA_DIR:-dcrpulse_app-data}
    driver: local
